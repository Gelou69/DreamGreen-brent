<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Products - The Little Nest</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* General Page Styles */
    /* Style for the dropdown menu container */
.dropdown-allproducts {
  position: absolute;
  top: 100%; /* Position below the main nav item */
  left: 0;
  background-color: #fff;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  display: none; /* Hidden by default */
  min-width: 800px; /* Adjust as needed */
  z-index: 100;
}

/* Make the dropdown visible on hover */
.header-nav > li:hover > .dropdown-allproducts {
  display: block;
}

/* Grid layout for the product items */
.dropdown-products-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* Creates 4 columns */
  gap: 1rem; /* Space between grid items */
}

/* Style for each individual product item */
.product-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 1rem;
  border: 1px solid #ccc; /* Border around each item */
  border-radius: 8px;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
}

.product-item:hover {
  transform: translateY(-5px); /* Slight lift on hover */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Style for the images inside the grid items */
.product-item img {
  width: 100px; /* Adjust size as needed */
  height: auto;
  margin-bottom: 0.5rem;
}

/* Style for the product names */
.product-item .product-name {
  font-weight: bold;
  font-size: 0.9em;
  color: #333;
}
    .dropdown-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.dropdown-image {
    position: relative;
    max-width: 90%;
    max-height: 90%;
}
    .products-container h1 {
      text-align: center;
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 2rem;
      color: #2c3e50;
    }

    /* Categories Filter */
    .categories-filter {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .category-btn {
      background-color: #000000;
      border: none;
      border-radius: 20px;
      padding: 0.5rem 1.25rem;
      font-size: 1rem;
      color: #ffffff;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }

    .category-btn:hover,
    .category-btn[aria-pressed="true"] {
      background-color: #b4b4b4;
      color: rgb(0, 0, 0);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    /* Responsive Product Grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2rem;
    }

    .product-grid p {
      grid-column: 1 / -1;
      text-align: center;
      font-size: 1.1rem;
      color: #666;
    }

    /* Enhanced Product Card */
    .product-card {
      background: linear-gradient(145deg, #f0f4f8, #d9e2ec);
      border-radius: 15px;
      box-shadow: 8px 8px 15px #b8c6db, -8px -8px 15px #ffffff;
      overflow: hidden;
      position: relative;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      opacity: 0;
      transform: translateY(20px);
      animation: flowIn 0.5s ease-out forwards;
      animation-delay: calc(var(--i) * 100ms);
      display: flex;
      flex-direction: column;
    }

    @keyframes flowIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .product-card:hover {
      transform: translateY(-10px);
      box-shadow: 12px 12px 20px #a1b1c9, -12px -12px 20px #ffffff;
    }

    .product-image {
    width: 100%;
    height: 220px;
    object-fit: contain; /* Show entire image without cropping */
    background-color: #eee;
    border-bottom: 1px solid #ccc;
    border-radius: 15px 15px 0 0;
}

    .product-info {
      padding: 1rem 1.5rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-info h3 {
      margin: 0 0 0.5rem;
      font-size: 1.3rem;
      color: #1a2a44;
      font-weight: 700;
    }

    .product-description {
      font-size: 0.95rem;
      color: #4a5a6a;
      line-height: 1.4;
      height: 4.5em;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .product-price {
      font-size: 1.4rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 1rem;
    }

    /* Quantity Selector */
    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .quantity-selector label {
      font-size: 0.9rem;
      color: #2c3e50;
    }

    .quantity-selector input[type="number"] {
      width: 60px;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-align: center;
    }

    .quantity-selector input[type="number"]::-webkit-inner-spin-button,
    .quantity-selector input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Add to Cart Button */
    .add-to-cart-btn {
      padding: 0.75rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      color: white;
      background-color: #000000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .add-to-cart-btn:hover:not(:disabled) {
      background-color: #ffffff;
      color: black;
    }

    .add-to-cart-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    /* Hover Overlay */
    .product-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(44, 62, 80, 0.75);
      display: flex;
      justify-content: center;
      align-items: flex-end;
      opacity: 0;
      transition: opacity 0.3s ease;
      padding: 1rem 1.5rem;
      border-radius: 15px;
    }

    .product-card:hover .product-overlay {
      opacity: 1;
    }

    /* Cart Badge Styles */
    .cart-badge {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 19px;
      right: 500px;
      background-color: #ffffff;
      color: rgb(0, 0, 0);
      font-size: 0.75rem;
      font-weight: bold;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease-in-out;
    }

    .cart-badge.visible {
      opacity: 1;
      transform: scale(1);
    }

    /* --- Modal Styles --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none; /* Initially hidden */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 2rem;
      font-weight: 300;
      cursor: pointer;
      color: #888;
    }

    .modal-title {
      text-align: center;
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 1.5rem;
    }

    #cartItemsContainer {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 15px;
      margin-bottom: 1rem;
    }

    /* Cart Item Card */
    .cart-item {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #eee;
      gap: 1.5rem;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
    }

    .cart-item-details {
      flex-grow: 1;
    }

    .cart-item-name {
      font-weight: bold;
      margin: 0;
    }

    .cart-item-price {
      color: #3498db;
      margin: 0.25rem 0;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quantity-btn {
      background: #f1f1f1;
      border: 1px solid #ddd;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
    }

    .quantity-btn:hover {
      background: #e0e0e0;
    }

    .item-quantity {
      width: 40px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.25rem;
    }

    .remove-item-btn {
      background: transparent;
      border: none;
      color: #e74c3c;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: auto;
    }

    /* Cart Summary */
    .cart-summary {
      padding-top: 1rem;
      border-top: 2px solid #f0f0f0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .total-row {
      font-size: 1.4rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .checkout-btn {
      width: 100%;
      padding: 1rem;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: background-color 0.2s;
      text-align: center;
      display: inline-block;
      text-decoration: none;
    }

    .checkout-btn:hover {
      background-color: #a8a8a8;
      color: #000;
    }

    .empty-cart-message {
      text-align: center;
      color: #666;
      margin: 2rem 0;
    }

    /* Styles for the new Login Prompt Modal */
    .modal-message {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      color: #555;
    }
  </style>
</head>
<body>
<header>
    <div class="logo" aria-label="The Little Nest logo and tagline">
      <a href="homepage.html"><img class="logo1" src="logo-white.png" alt=""></a>
    </div>

    <form role="search" class="search-container" aria-label="Search for products">
      <input type="search" placeholder="Search for products" aria-label="Search for products" name="search"
        id="searchInput" autocomplete="off" />
      <button type="submit" aria-label="Search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M21.71 20.29l-4.388-4.388A7.95 7.95 0 0016 10a8 8 0 10-8 8 7.95 7.95 0 005.907-2.678l4.388 4.388a1 1 0 001.414-1.414zM4 10a6 6 0 116 6 6 6 0 01-6-6z" />
        </svg>
      </button>
    </form>

    <div class="header-buttons" role="region" aria-label="User options and cart">
  <!-- Login / Signup -->
  <a href="account.html" class="btn-outline" aria-label="Login or Sign up" id="authBtn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm-7 8a7 7 0 0 1 14 0z" />
    </svg>
    Login or SIGN UP
  </a>

 
  <!-- Cart -->
  <button class="btn-outline" aria-label="View cart">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm10 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2zM7 14h10l3-9H6.21l-.21-1H1v2h3l3.6 7.59-1.35 2.44A1 1 0 0 0 7 15h9v-2H7z" />
    </svg>
    CART
    <span class="cart-badge" id="cart-count"></span>
  </button>
</div>

 <!-- Logout -->
  <a href="login.html" class="btn-outline" aria-label="Logout" id="logoutBtn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3H10v2h10v14H10v2h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
    </svg>
    Logout
  </a>

  </header>

  <nav role="navigation" aria-label="Main navigation">
    <ul class="header-nav">
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-allproducts">
        All Products 
        <ul id="dropdown-allproducts" role="menu" aria-label="All Products submenu">
                    <a href="order.html"><li><img src="pillows.png" alt="Pillows"> Pillows</li></a>
                    <a href="order.html"><li><img src="sheets.png" alt="Sheets"> Sheets</li></a>
                    <a href="order.html"><li><img src="towel.png" alt="Towels"> Towels</li></a>
                   <a href="order.html"> <li><img src="quilts.png" alt="Quilts"> Quilts</li></a>
                    <a href="order.html"><li><img src="matressess.png" alt="Mattresses"> Mattresses</li></a>
                    <a href="order.html"><li><img src="robes.png" alt="Robes"> Robes</li></a>
                    <a href="order.html"><li><img src="duvet.png" alt="Duvets"> Duvets</li></a>
                </ul>
      </li>
      <li  tabindex="0"><a href="dreamgreen.html">DreamGreen</a></li>
      <li tabindex="0"><a href="faqs.html">FAQ's/Blog</a></li>
      <li tabindex="0"><a href="about.html">About</a></li>
      <li tabindex="0"><a href="contacts.html">Contact</a></li>
      <div class="announcement" role="alert" aria-live="polite">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 2a10 10 0 1 1 0 20 10 10 0 0 1 0-20zm-1 5a1 1 0 0 0-2 0v6a1 1 0 0 0 2 0V7zm2 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill-rule="evenodd" clip-rule="evenodd"/>
        </svg>
        Orders will be dispatched next Monday.
      </div>
    </ul>
  </nav>

  <main>
    <section class="products-container" aria-labelledby="products-heading">
      <h1 id="products-heading">Our Cozy Collection</h1>

      <!-- Categories Filter -->
      <div class="categories-filter" role="region" aria-label="Product categories filter">
        <button class="category-btn active" data-category="all" aria-pressed="true">All</button>
        <button class="category-btn" data-category="DreamGreen" aria-pressed="false">DreamGreen</button>
        <button class="category-btn" data-category="Pillows" aria-pressed="false">Pillows</button>
        <button class="category-btn" data-category="Sheets" aria-pressed="false">Sheets</button>
        <button class="category-btn" data-category="Towels" aria-pressed="false">Towels</button>
        <button class="category-btn" data-category="Quilts" aria-pressed="false">Quilts</button>
        <button class="category-btn" data-category="Mattresses" aria-pressed="false">Mattresses</button>
        <button class="category-btn" data-category="Robes" aria-pressed="false">Robes</button>
        <button class="category-btn" data-category="Duvets" aria-pressed="false">Duvets</button>
      </div>

      <div class="product-grid" id="product-grid">
        <p>Loading our wonderful products...</p>
      </div>
    </section>
  </main>

  <div id="cartModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="cartModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" aria-label="Close cart modal">&times;</button>
      <h2 class="modal-title" id="cartModalTitle">Your Cart</h2>
      <div id="cartItemsContainer">
        <p class="empty-cart-message">Your cart is empty.</p>
      </div>
      <div id="cartSummary" class="cart-summary" style="display: none;">
        <div class="summary-row">
          <span>Subtotal:</span>
          <span id="subtotalPrice">$0.00</span>
        </div>
        <div class="summary-row shipping-row">
          <span>Shipping Fee:</span>
          <span id="shippingFee">$5.00</span>
        </div>
        <hr />
        <div class="summary-row total-row">
          <span>Total:</span>
          <span id="totalPrice">$0.00</span>
        </div>
        <a href="checkout.html" class="checkout-btn" style="text-decoration: none;">Proceed to Checkout</a>
      </div>
    </div>
  </div>

  <!-- Login Prompt Modal -->
  <div id="loginPromptModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="loginPromptTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" aria-label="Close login prompt modal">&times;</button>
      <h2 class="modal-title" id="loginPromptTitle">Login Required</h2>
      <p class="modal-message">Please log in to add items to your cart and proceed with your order.</p>
      <button id="loginRedirectBtn" class="checkout-btn">Go to Login Page</button>
    </div>
  </div>

  <footer aria-label="Footer">
    <div class="footer-nav" aria-label="General Site Links">
      <ul>
        <li><a href="about.html">About</a></li>
        <li><a href="dreamgreen.html">DreamGreen</a></li>
        <li><a href="faqs.html">FAQâ€™s/Blog</a></li>
        <li><a href="contacts.html">Contact</a></li>
        <li><a href="products.html">Products</a></li>
      </ul>
    </div>

    <div class="footer-nav" aria-label="Account Links">
      <ul>
        <li><a href="accounts.html">My Account</a></li>
        <li><a href="order-tracking.html">My Orders</a></li>
        <li><a href="#">My Favourites</a></li>
        <li><a href="#">My Returns</a></li>
        <li><a href="login.html">Login</a></li>
        <li><a href="#">Terms & Conditions</a></li>
        <li><a href="#">Returns & Shipping</a></li>
      </ul>
    </div>

    <div class="logo-footer" aria-label="The Little Nest logo and tagline">
      <img class="logo2" src="logo-black.png" alt="The Little Nest logo" />
    </div>

    <div class="footer-contact">
      <strong>Contact Us</strong>
      <p>Talk: 0000 000 000</p>
      <p>Type: <a href="mailto:sales@thelittlenest.co.nz">sales@thelittlenest.co.nz</a></p>
      <p>View: <a href="https://www.thelittlenest.co.nz" target="_blank" rel="noopener noreferrer">www.thelittlenest.co.nz</a></p>
      <p>Visit: Marlborough, New Zealand</p>
      <div class="socials" aria-label="Social media links">
        <!-- Social SVG icons here (same as before) -->
        <!-- ... -->
      </div>
    </div>
  </footer>

  <!-- Leave us a message button -->
  <div class="leave-message" tabindex="0" id="chatBtn">Leave us a message</div>

  <script src="homepage.js"></script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const supabaseUrl = 'https://aiwthvlhyyjplajtrhob.supabase.co';
  const supabaseKey =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpd3RodmxoeXlqcGxhanRyaG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzUwNzQsImV4cCI6MjA3MjU1MTA3NH0.sjZoaEqik_YZJ_S4KDKaDAy5jlxquxzJGwvCrLPOcRQ';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const authBtn = document.getElementById('authBtn');
  const productGrid = document.getElementById('product-grid');
  const cartCountBadge = document.getElementById('cart-count'); // Correctly defined here
  const cartModal = document.getElementById('cartModal');
  const cartItemsContainer = document.getElementById('cartItemsContainer');
  const subtotalPrice = document.getElementById('subtotalPrice');
  const shippingFee = document.getElementById('shippingFee');
  const totalPrice = document.getElementById('totalPrice');
  const cartSummary = document.getElementById('cartSummary');
  let currentUser = null;
  let allProducts = [];
  let selectedCategory = 'all';

  // New elements for login prompt modal
  const loginPromptModal = document.getElementById('loginPromptModal');
  const loginRedirectBtn = document.getElementById('loginRedirectBtn');

  async function updateCartCount() {
    if (!currentUser) {
      if (cartCountBadge) {
        cartCountBadge.classList.remove('visible');
        cartCountBadge.textContent = '';
      }
      return;
    }
    try {
      const { count, error } = await supabase
        .from('cart')
        .select('product_id', { count: 'exact', head: true })
        .eq('user_id', currentUser.id);

      if (error) throw error;
      if (count > 0) {
        if (cartCountBadge) {
          cartCountBadge.textContent = count;
          cartCountBadge.classList.add('visible');
        }
      } else {
        if (cartCountBadge) {
          cartCountBadge.textContent = '';
          cartCountBadge.classList.remove('visible');
        }
      }
    } catch (error) {
      console.error('Error fetching cart count:', error.message);
    }
  }

  async function checkAuthAndLoadProducts() {
  try {
    const {
      data: { session },
      error,
    } = await supabase.auth.getSession();
    if (error) throw error;
    if (session) {
      currentUser  = session.user;
      const userFirstName = currentUser .email.split('@')[0];
      authBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm-7 8a7 7 0 0 1 14 0z"/></svg> ${userFirstName}`;
      authBtn.setAttribute('aria-label', `Logged in as ${currentUser .email}. Click to log out.`);
      authBtn.addEventListener('click', logout);
      await fetchAndDisplayProducts();
      await updateCartCount();
    } else {
      // Show modal instead of redirect
      showLoginRequiredModal();
    }
  } catch (authError) {
    console.error('Authentication error:', authError);
    productGrid.innerHTML = `<p>Could not verify your session. Please try logging in again.</p>`;
  }
}

function showLoginRequiredModal() {
  let modal = document.getElementById('login-required-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'login-required-modal';

    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '1000';
    modal.style.opacity = '0';
    modal.style.animation = 'fadeInModal 0.4s forwards';

    modal.innerHTML = `
      <style>
        @keyframes fadeInModal {
          to { opacity: 1; }
        }
        @keyframes slideUp {
          to { transform: translateY(0); }
        }
        #login-required-modal .modal-content {
          background: #111;
          padding: 2.5rem 3rem;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(255, 255, 255, 0.15);
          max-width: 420px;
          width: 90%;
          text-align: center;
          color: #eee;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          transform: translateY(-20px);
          animation: slideUp 0.4s forwards;
          border: 2px solid #eee;
        }
        #login-required-modal p {
          font-size: 1.2rem;
          margin-bottom: 1.8rem;
          font-weight: 600;
          text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }
        #go-to-login-btn {
          background: #eee;
          color: #111;
          border: 2px solid #eee;
          padding: 0.75rem 2rem;
          font-size: 1.1rem;
          font-weight: 700;
          border-radius: 50px;
          cursor: pointer;
          box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
          transition: all 0.3s ease;
          user-select: none;
        }
        #go-to-login-btn:hover {
          background: #111;
          color: #eee;
          border-color: #eee;
          box-shadow: 0 8px 20px rgba(255, 255, 255, 0.6);
          transform: scale(1.05);
        }
        #go-to-login-btn:active {
          transform: scale(0.95);
          box-shadow: 0 4px 10px rgba(255, 255, 255, 0.4);
        }
      </style>
      <div class="modal-content">
        <p>You need to log in first to access this content.</p>
        <button id="go-to-login-btn">Login</button>
      </div>
    `;

    document.body.appendChild(modal);

    document.getElementById('go-to-login-btn').addEventListener('click', () => {
      window.location.href = 'login.html';
    });
  }

  modal.style.display = 'flex';
}

  async function fetchAndDisplayProducts() {
    try {
      const { data: products, error } = await supabase.from('products').select('*').order('name');
      if (error) throw error;
      allProducts = products;
      renderProducts();
    } catch (error) {
      console.error('Error fetching products:', error.message);
      productGrid.innerHTML = '<p>Sorry, we couldn\'t load our products. Please try refreshing the page.</p>';
    }
  }

  function renderProducts() {
    productGrid.innerHTML = '';
    const filteredProducts =
      selectedCategory === 'all' ? allProducts : allProducts.filter((p) => p.category === selectedCategory);

    if (filteredProducts.length === 0) {
      productGrid.innerHTML = '<p>No products found in this category.</p>';
      return;
    }

    filteredProducts.forEach((product, index) => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.style.setProperty('--i', index);

      const stock = product.quantity ?? 0;
      const outOfStock = stock === 0;
      const buttonText = outOfStock ? 'Out of Stock' : 'Add to Cart';

      card.innerHTML = `
        <img src="${product.image_url}" alt="${product.name}" class="product-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/eee/ccc?text=Image+Not+Found';" />
        <div class="product-info">
          <h3>${product.name}</h3>
          <p class="product-description">${product.description}</p>
          <p class="product-price">$${Number(product.price).toFixed(2)}</p>
          <p class="stock-info">${outOfStock ? 'Out of Stock' : `In Stock: ${stock}`}</p>
          <div class="quantity-selector">
            <label for="qty-${product.id}">Qty:</label>
            <input type="number" id="qty-${product.id}" name="quantity" min="1" max="${stock}" value="1" aria-label="Quantity for ${product.name}" ${outOfStock ? 'disabled' : ''} />
          </div>
          <button class="add-to-cart-btn" data-product-id="${product.id}" ${outOfStock ? 'disabled' : ''}>
            ${buttonText}
          </button>
        </div>
        <div class="product-overlay">
          <button class="add-to-cart-btn" data-product-id="${product.id}" ${outOfStock ? 'disabled' : ''}>
            ${buttonText}
          </button>
        </div>
      `;
      productGrid.appendChild(card);
    });
  }

  // Category filter buttons event
  document.querySelector('.categories-filter').addEventListener('click', (e) => {
    if (!e.target.classList.contains('category-btn')) return;
    const buttons = document.querySelectorAll('.category-btn');
    buttons.forEach((btn) => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', 'false');
    });
    e.target.classList.add('active');
    e.target.setAttribute('aria-pressed', 'true');
    selectedCategory = e.target.dataset.category;
    renderProducts();
  });

  // Function to open the login prompt modal
  function openLoginPromptModal() {
    loginPromptModal.style.display = 'flex';
    loginPromptModal.focus();
  }

  // Function to close the login prompt modal
  function closeLoginPromptModal() {
    loginPromptModal.style.display = 'none';
  }

  // Event listener for the "Go to Login Page" button in the prompt modal
  loginRedirectBtn.addEventListener('click', () => {
    closeLoginPromptModal();
    window.location.href = 'login.html';
  });

  // Event listener to close the login prompt modal when clicking outside
  loginPromptModal.addEventListener('click', (event) => {
    if (event.target === loginPromptModal) {
      closeLoginPromptModal();
    }
  });

  // Event listener for the close button in the login prompt modal
  loginPromptModal.querySelector('.close-btn').addEventListener('click', closeLoginPromptModal);


  async function handleAddToCart(event) {
    if (!event.target.classList.contains('add-to-cart-btn')) return;
    if (!currentUser) {
      // Open the login prompt modal instead of alert
      openLoginPromptModal();
      return;
    }
    const button = event.target;
    const productId = parseInt(button.dataset.productId, 10);
    const productCard = button.closest('.product-card');
    const qtyInput = productCard.querySelector('input[type="number"]');
    let quantity = parseInt(qtyInput.value, 10);

    // Find product stock from allProducts
    const product = allProducts.find((p) => p.id === productId);
    if (!product) {
      alert('Product not found.');
      return;
    }

    if (product.quantity === 0) {
      alert('Sorry, this product is out of stock.');
      return;
    }

    if (isNaN(quantity) || quantity < 1) {
      alert('Please enter a valid quantity (1 or more).');
      qtyInput.value = 1; // Reset to 1 for better user experience
      return;
    }

    if (quantity > product.quantity) {
      alert(`Sorry, only ${product.quantity} item(s) available in stock.`);
      qtyInput.value = product.quantity;
      return;
    }

    // Check if product is already in cart
    const { data: existingCartItem, error: fetchError } = await supabase
      .from('cart')
      .select('id, quantity')
      .eq('user_id', currentUser.id)
      .eq('product_id', productId)
      .limit(1)
      .maybeSingle();

    if (fetchError) {
      console.error('Error checking cart:', fetchError);
      alert('Could not verify cart status. Please try again.');
      return;
    }

    if (existingCartItem) {
      alert('This item is already in your cart.');
      button.textContent = 'In Cart';
      button.disabled = true;
      return;
    }

    button.disabled = true;
    button.textContent = 'Adding...';

    try {
      // Insert item into cart
      const { error: insertError } = await supabase.from('cart').insert([
        {
          user_id: currentUser.id,
          product_id: productId,
          quantity: quantity,
        },
      ]);

      if (insertError) {
        throw insertError;
      }

      // Update product stock quantity in products table
      const newStock = product.quantity - quantity;
      const { error: updateError } = await supabase
        .from('products')
        .update({ quantity: newStock })
        .eq('id', product.id);

      if (updateError) {
        console.error('Error updating product stock:', updateError);
        alert('Added to cart but failed to update stock. Please contact support.');
        // Optionally, rollback cart insert here if needed
      } else {
        // Update local product quantity to reflect new stock
        product.quantity = newStock;
        // Update UI for this product card
        const stockInfo = productCard.querySelector('.stock-info');
        const qtyInput = productCard.querySelector('input[type="number"]');
        if (newStock === 0) {
          stockInfo.textContent = 'Out of Stock';
          qtyInput.disabled = true;
          button.textContent = 'Out of Stock';
          button.disabled = true;
        } else {
          stockInfo.textContent = `In Stock: ${newStock}`;
          qtyInput.max = newStock;
          button.textContent = 'Added!';
        }
      }

      await updateCartCount();

      setTimeout(() => {
        button.textContent = 'In Cart';
        button.disabled = true;
      }, 1000);
    } catch (error) {
      console.error('Error adding to cart:', error);
      alert('Could not add item to cart. Please try again.');
      button.disabled = false;
      button.textContent = 'Add to Cart';
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  }

  // Modal functions and cart management
  async function openCartModal() {
    if (!currentUser) {
      // Open the login prompt modal if user is not logged in
      openLoginPromptModal();
      return;
    }
    await fetchCartItems();
    cartModal.style.display = 'flex';
    cartModal.focus();
  }

  function closeCartModal() {
    cartModal.style.display = 'none';
  }

  async function fetchCartItems() {
    try {
      const { data: cartItems, error } = await supabase
        .from('cart')
        .select(`
          id,
          quantity,
          products (
            id,
            name,
            price,
            image_url
          )
        `)
        .eq('user_id', currentUser.id)
        .order('id');
      if (error) throw error;
      cartItemsContainer.innerHTML = '';
      let subtotal = 0;
      if (cartItems.length === 0) {
        cartItemsContainer.innerHTML = '<p class="empty-cart-message">Your cart is empty.</p>';
        cartSummary.style.display = 'none';
        return;
      }

      cartItems.forEach((item) => {
        const product = item.products;
        const itemPrice = product.price * item.quantity;
        subtotal += itemPrice;

        const cartItemDiv = document.createElement('div');
        cartItemDiv.className = 'cart-item';
        cartItemDiv.dataset.itemId = item.id;
        cartItemDiv.innerHTML = `
          <img src="${product.image_url}" alt="${product.name}" class="cart-item-img" />
          <div class="cart-item-details">
            <p class="cart-item-name">${product.name}</p>
            <p class="cart-item-price">$${Number(product.price).toFixed(2)}</p>
          </div>
          <div class="quantity-controls">
            <button class="quantity-btn decrease-btn" data-id="${item.id}" aria-label="Decrease quantity">-</button>
            <span class="item-quantity" aria-live="polite">${item.quantity}</span>
            <button class="quantity-btn increase-btn" data-id="${item.id}" aria-label="Increase quantity">+</button>
          </div>
          <button class="remove-item-btn" data-id="${item.id}" aria-label="Remove item">&times;</button>
        `;
        cartItemsContainer.appendChild(cartItemDiv);
      });

      const shipping = 5.0;
      const total = subtotal + shipping;
      subtotalPrice.textContent = `$${subtotal.toFixed(2)}`;
      shippingFee.textContent = `$${shipping.toFixed(2)}`;
      totalPrice.textContent = `$${total.toFixed(2)}`;
      cartSummary.style.display = 'block';
    } catch (error) {
      console.error('Error fetching cart items:', error.message);
      cartItemsContainer.innerHTML = '<p class="empty-cart-message">Could not load cart. Please try again.</p>';
      cartSummary.style.display = 'none';
    }
  }

  async function handleCartAction(event) {
    const target = event.target;
    const itemId = target.dataset.id;
    if (!itemId) return;

    if (target.matches('.remove-item-btn')) {
      await removeItem(itemId);
    } else if (target.matches('.increase-btn')) {
      await changeQuantity(itemId, 1);
    } else if (target.matches('.decrease-btn')) {
      await changeQuantity(itemId, -1);
    }
  }

  async function removeItem(itemId) {
    try {
      const { error } = await supabase.from('cart').delete().eq('id', itemId);
      if (error) throw error;
      await fetchCartItems();
      await updateCartCount();
    } catch (error) {
      console.error('Error removing item:', error.message);
      alert('Failed to remove item. Please try again.');
    }
  }

  async function changeQuantity(itemId, change) {
    try {
      const { data: cartItem, error: fetchError } = await supabase.from('cart').select('quantity').eq('id', itemId).single();
      if (fetchError) throw fetchError;
      const newQuantity = cartItem.quantity + change;
      if (newQuantity <= 0) {
        await removeItem(itemId);
        return;
      }

      const { error: updateError } = await supabase.from('cart').update({ quantity: newQuantity }).eq('id', itemId);
      if (updateError) throw updateError;
      await fetchCartItems();
    } catch (error) {
      console.error('Error changing quantity:', error.message);
      alert('Failed to change quantity. Please try again.');
    }
  }

  // Event Listeners for the cart modal
  document.querySelector('#cartModal .close-btn').addEventListener('click', closeCartModal);
  document.querySelector('.btn-outline[aria-label="View cart"]').addEventListener('click', openCartModal);
  cartModal.addEventListener('click', (event) => {
    if (event.target === cartModal) {
      closeCartModal();
    }
  });
  cartItemsContainer.addEventListener('click', handleCartAction);

  // Checkout button closes modal
  document.querySelector('a.checkout-btn').addEventListener('click', () => {
    closeCartModal();
  });

  // Initial function call
  document.addEventListener('DOMContentLoaded', checkAuthAndLoadProducts);
  productGrid.addEventListener('click', handleAddToCart);
</script>

</body>
</html>
